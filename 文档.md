# Annotations2Sub

将 YouTube 注释转换为字幕.

[![License GPLv3](https://img.shields.io/pypi/l/Annotations2Sub?color=1)](https://pypi.org/project/Annotations2Sub/)
[![Test](https://github.com/USED255/Annotations2Sub/actions/workflows/test.yml/badge.svg)](https://github.com/USED255/Annotations2Sub/actions/workflows/test.yml)
[![codecov](https://codecov.io/gh/USED255/Annotations2Sub/branch/master/graph/badge.svg?token=SSNQNEAXMP)](https://codecov.io/gh/USED255/Annotations2Sub)
[![Version](https://img.shields.io/pypi/v/Annotations2Sub)](https://pypi.org/project/Annotations2Sub)
[![Python version](https://img.shields.io/pypi/pyversions/Annotations2Sub)](https://pypi.org/project/Annotations2Sub)

## 目录

- [简介](#简介)
- [开始使用](#开始使用)
  - [前提条件](#前提条件)
    - [安装 Python](#安装-python)
    - [获得原视频](#获得原视频)
    - [获取注释文件](#获取注释文件)
    - [选择播放器](#选择播放器)
  - [安装](#安装)
  - [转换注释](#转换注释)
  - [播放视频](#播放视频)
  - [效果](#效果)
  - [可选: 嵌入到视频中](#可选-嵌入到视频中)
- [命令行用法](#命令行用法)
  - [参数](#参数)
  - [选项](#选项)
    - [-h 查看帮助](#查看帮助)
    - [-x -y 变换分辨率](#变换分辨率)
    - [-f 指定字体](#指定字体)
    - [-n 不覆盖文件](#不覆盖文件)
    - [-o 保存到此文件](#保存到此文件)
    - [-O 指定转换后文件的输出目录](#指定转换后文件的输出目录)
    - [-v 显示版本号](#显示版本号)
    - [-V 显示更多消息](#显示更多消息)
  - [返回码](#返回码)
- [局限性](#局限性)
- [获得帮助](#获得帮助)
- [贡献](#贡献)
- [许可证](#许可证)
- [致谢](#致谢)
- [杂项](#杂项)
  - [重要更新](#重要更新)
  - [二次开发](#二次开发)
  - [与同类软件的对比](#与同类软件的对比)
  - [衍生项目](#衍生项目)

## 简介

YouTube 注释是 YouTube 于 2008 年推出的一项功能, 允许视频创作者在视频中添加文本、链接和互动元素, 以增强观看体验. YouTube 于 2019 年移除了此功能.

ASS 字幕是一种常见的外挂字幕格式, 全称 Advanced SubStation Alpha. 与其他字幕格式相比, 他能够设置字体、颜色、位置, 甚至添加图像和特效, 增强您的观看体验.

此工具可以帮助您将 YouTube 注释转换为 ASS 字幕文件, 您可以播放或添加到视频中. 如果您不需要此功能, 建议使用 [AnnotationsRestored](https://github.com/isaackd/AnnotationsRestored).

## 开始使用

### 前提条件

在开始之前, 要准备好 Python, 视频文件, YouTube 注释的 XML 文件, 视频播放器, 以及其相关背景知识.

#### 安装 Python

Python 是一种广泛使用的高级编程语言, 本工具使用 Python 编写, 因此需要安装 Python 3.7 或更高版本.

##### Windows

1. 打开开始菜单, 找到并打开 Microsoft Store.
2. 搜索 Python.
3. 打开 Python 3.13 (或者其他版本) 的详情页面并安装.

##### 其他

请访问 [Python Setup and Usage](https://docs.python.org/3/using/index.html)

#### 获得原视频

建议使用 [yt-dlp](https://github.com/yt-dlp/yt-dlp) 来下载视频, yt-dlp 是一个多用途视频下载器, 可以下载 Youtube 视频.

1. 打开开始菜单, 找到并打开 "终端".
2. 粘贴以下命令并回车:

```shell
pip install yt-dlp
```

3. 等待安装完成.
4. 使用以下命令下载视频:

```shell
yt-dlp 这里换成你要下载的视频的网址
```

#### 获取注释文件

注释文件是 XML 格式，以 `.xml` 为扩展名. 您可以通过以下途径获取注释文件:

1. 使用 [AnnotationsRestored](https://github.com/isaackd/AnnotationsRestored) 浏览器扩展.
2. [Internet Archive](https://archive.org/details/youtubeannotations) 的存档.
3. 其他用户分享的注释文件

建议使用 [AnnotationsRestored](https://github.com/isaackd/AnnotationsRestored) 扩展来下载注释文件, 在视频页点击扩展图标, 然后点击 "下载" 即可.

#### 选择播放器

推荐使用以下播放器，它们都支持 ASS 字幕：

1. [mpv](https://mpv.io/)
2. [VLC](https://www.videolan.org/)
3. [PotPlayer](https://potplayer.daum.net/)
4. [MPC-HC](https://github.com/clsid2/mpc-hc)
5. [SMPlayer](https://www.smplayer.info/)

不同播放器对 ASS 字幕的渲染效果会有所不同, 建议使用 mpv.

### 安装

打开终端,使用 pip 来安装 Annotations2Sub:

```shell
pip install Annotations2Sub
```

### 转换注释

1. 在注释文件所在文件夹右键空白处选择"在终端中打开".
2. 运行命令:

```shell
Annotations2Sub 注释.xml
```

字幕文件会保存到与注释文件相同的目录下.

### 播放视频

1. 确保视频文件和转换后的 .ass 字幕文件在同一目录下.
2. 使用支持 ASS 字幕的播放器打开视频.
3. 播放器会自动加载字幕文件 (也可以拖放或通过右键菜单手动加载).

### 效果

- 注释应当正常的显示于视频之上.
- 受限于技术原因无法与注释互动, 包括关闭注释, 打开链接, 展开详情, 跳转到其他视频, 暂停等.
- 一些注释可能显示错误或丢失, 请在 [Issues](https://github.com/USED255/Annotations2Sub/issues) 中报告这些问题.

### 可选: 嵌入到视频中

如果您想将字幕嵌入视频, 以便发布到视频网站, 可以使用以下工具：

1. [FFmpeg](https://ffmpeg.org/): 命令行工具, 功能强大.

   ```shell
   ffmpeg -i 视频.mp4 -vf ass=注释.xml.ass 输出.mp4
   ```

2. [HandBrake](https://handbrake.fr/): 图形界面，易于使用.
   - 加载视频
   - 在字幕选项中导入字幕
   - 勾选"烧入"
   - 开始转码

## 命令行用法

### 参数

参数是一个或多个需要转换的注释文件的文件路径.

"注释文件" 是一个 XML 文档, 如果你没有这个文件, 你应该参考 [获取注释文件](#获取注释文件) 章节.

示例:

```shell
Annotations2Sub annotations.xml
```

注释会被转换为 ASS 字幕文件, 并保存到 "注释文件" 的同目录下,
使用支持 ASS 字幕的视频播放器加载视频和输出的字幕文件可以看到效果.

输出:

```text
保存于: "annotations.xml.ass"
```

### 选项

#### 查看帮助

`-h, --help show this help message and exit`

示例:

```shell
Annotations2Sub -h
```

输出:

```shell
usage: Annotations2Sub [-h] [-x 1920] [-y 1080] [-f Microsoft YaHei]
                   [-n] [-o 文件] [-O 目录] [-v] [-V]
                   文件 [文件]

下载和转换 Youtube 注释

positional arguments:
  文件 或 videoId          多个需要转换的文件的文件路径或视频ID

options:
  -h, --help            show this help message and exit
  -x 1920, --transform-resolution-x 1920
                        变换分辨率X
  -y 1080, --transform-resolution-y 1080
                        变换分辨率Y
  -f Microsoft YaHei, --font Microsoft YaHei
                        指定字体
  -n, --no-overwrite-files
                        不覆盖文件
  -o 文件, --output 文件    保存到此文件, 如果为 "-" 则输出到标准输出
  -O 目录, --output-directory 目录
                        指定转换后文件的输出目录
  -v, --version         显示版本号
  -V, --verbose         显示更多消息
```

#### 变换分辨率

`-x 1920, --transform-resolution-x 1920 变换分辨率X`

`-y 1080, --transform-resolution-y 1080 变换分辨率Y`

只有在画 highlight 类型的注释或者 label 样式的注释的"框"时,
才会真正需要分辨率这个信息, 因此这个参数是可选的.

字幕滤镜会正确处理字幕脚本的 "PlayRes{X,Y}". 部分播放器使用的字幕滤镜会出现奇怪的行为,
比如 X 轴的数值直接使用 Y 的数值, 这会造成渲染错误, 在此时需要使用这个参数.

示例:

```shell
Annotations2Sub -x 1920 -y 1080 annotations.xml
```

效果: 可能没有明显变化.

#### 指定字体

`-f Microsoft YaHei, --font Microsoft YaHei 指定字体`

Annotations 使用的是无衬线字体, 但是 ```font-family: sans-serif```
实际选择的字体会因为已安装的字体不同; 浏览器的不同; 语言环境的不同而有显著的差异.
不同的字幕滤镜处理字体的行为也不同, 不同电脑用的字体也不同, 因此出现字体问题是正常的.
出现字体问题时可能需要使用这个参数.

示例:

```shell
Annotations2Sub -f Arial annotations.xml
```

效果: 显示的字体会变成您指定的字体.

#### 不覆盖文件

`-n, --no-overwrite-files 不覆盖文件`

默认情况下, 如果输出文件已存在, 会直接覆盖. 使用 `-n` 选项防止覆盖现有文件.

示例:

```shell
Annotations2Sub -n annotations.xml
```

效果: 如果 `annotations.xml.ass` 已经存在, 程序会跳过并显示警告消息.

#### 保存到此文件

`-o 文件, --output 文件 保存到此文件`

指定输出文件的路径和名称. 如果使用 "-" 作为参数, 则会将字幕内容输出到标准输出.

示例：

```shell
Annotations2Sub annotations.xml -o ../output.ass
```

效果: 字幕将保存到上一级目录, 名为`output.ass`.

```shell
Annotations2Sub annotations.xml -o -
```

效果: 您会看到字幕内容直接打印在终端上.

#### 指定转换后文件的输出目录

`-O 目录, --output-directory 目录 指定转换后文件的输出目录`

指定所有将要输出的文件的保存目录. 与 `-o` 选项不能同时使用.

示例：

```shell
Annotations2Sub annotations1.xml ../annotations2.xml -O output_dir
```

效果: 所有字幕文件将保存到 `output_dir` 目录下.

#### 显示版本号

`-v, --version 显示版本号`

显示当前运行的 Annotations2Sub 版本号并退出.

示例：

```shell
Annotations2Sub -v
```

输出:

```text
Annotations2Sub v2.24.0
```

#### 显示更多消息

`-V, --verbose 显示更多消息`

显示更多警告信息.

示例：

```shell
Annotations2Sub -V annotations.xml
```

效果: 会打印为什么某些注释没有被转换的原因, 以及 XML 解析异常的堆栈跟踪.

### 返回码

- 0: 成功
- 2: 参数错误
- 13: 不是文件
- 14: 不是 Annotations 文件
- 15: 无效的 XML 文档
- 18: 多个错误
- 19: 未知错误
- 20: 空文件

## 局限性

- 无法与注释互动, 不限于关闭注释, 打开链接, 展开详情, 跳转到其他视频, 暂停等.
- 效果会因播放器和字幕滤镜不同而不同.
- 无法准确的排版文本.
- 某些注释可能显示错误或丢失.

## 获得帮助

如果您遇到问题或需要帮助, 请打开一个 [Issues](https://github.com/USED255/Annotations2Sub/issues).

## 贡献

欢迎任何贡献, 即使只是修改了一个字符! 即使你不会编程, 也可以报告 Bug 或问我一些问题, 这样我就知道还有那些地方可以改进.
如果想开始编程, 可以阅读 [Annotations2Sub Source Code](src/README.md) 了解项目结构和代码风格.

## 许可证

本项目采用 [GNU通用公共许可证](https://www.gnu.org/licenses/gpl-3.0.html), 详情请参阅 [LICENSE](LICENSE) 文件.

## 致谢

[omarroth](https://archive.org/details/youtubeannotations)

创建了 YouTube 注释存档项目, 使得这些即将消失的内容得以保存, 也是工作得以开展的必要条件.

[Nirbheek Chauhan](https://github.com/nirbheek/youtube-ass)

制作了最早的 YouTube 注释转换工具, 本项目最初目的之一是为了修正其对 ASS 的实现问题.

[Zhenye Wei](https://github.com/weizhenye/ASS/wiki/ASS-字幕格式规范)

整理了详细的 ASS 字幕格式文档, 甚至指出了字幕滤镜的问题.

[Invidious](https://invidious.io/)

提供了 YouTube 的替代 API, 用于下载和预览视频.

[Isaac](https://github.com/isaackd/annotationlib)

annotationlib 的"简单格式"启发了软件的架构.

[Eva](https://github.com/po5/assnotations)

参考他的代码解决了一些难题.

[Internet Archive](https://archive.org/)

互联网档案馆为保存 YouTube 注释提供了基础支持. 本项目从其下载了注释存档和 Youtube 历史版本.

[Gemini 1.5 Pro](https://deepmind.google/models/gemini/pro/)

使用其 1M 上下文的能力帮助逆向了 Youtube 网页中注释相关文件.

[Rain Shimotsuki](https://www.youtube.com/@rain_shimotsuki)

他的视频和注释是本项目最初的动机.

[KeksusGSPB](https://www.youtube.com/watch?v=c1iCjpxDxz4)

使用了其注释作为回归基线.

[XNX.ROmania](https://web.archive.org/web/20230227230532/https://www.youtube.com/watch?v=M2ryDEyyrXE).

"The last annotations on YouTube" 展示了注释的能力, 为正确实现注释效果提供了参考.

## [回到顶部](#目录)

## 杂项

### 重要更新

- v2.23.0: 移除了下载注释, 预览和生成视频功能. 因为其依赖的服务已不可用.

### 二次开发

```Python
# 你可以将 Annotations2Sub 作为包导入:
from Annotations2Sub import *

"""
Annotations2Sub 导出了以下内容:
"version"
"Run"
"Parse"
"Annotation"
"Convert"
"Subtitles"
"Style"
"Event"
"NotAnnotationsDocumentError"
"AnnotationsXmlStringToSubtitlesString"
具体说明请参考对应的文档字符串.
"""

# 示例: 从文件读取注释并转换为字幕
with open('annotations.xml', 'r', encoding='utf-8') as f:
    xml_string = f.read()

# 将 XML 字符串转换为字幕字符串
subtitles_string = AnnotationsXmlStringToSubtitlesString(xml_string)

# 保存字幕文件
with open('output.ass', 'w', encoding='utf-8') as f:
    f.write(subtitles_string)

# 如果你担心许可证问题, 可以联系我给你其他许可证.
```

### 与同类软件的对比

目前市面上积极维护的同类软件只有 [AnnotationsRestored](https://github.com/isaackd/AnnotationsRestored).

AnnotationsRestored:

- 作为浏览器扩展, 可以直接在浏览器中还原和显示注释, 没有技术门槛.
- 支持互动功能, 如点击链接、展开详情等, 更接近原始 YouTube 注释的体验.
- 适合在线观看和浏览注释.

Annotations2Sub:

- 将注释保存为字幕文件, 可以进行二次编辑.
- 适合重新分发带注释的视频.

建议：

- 如果您只想观看带注释的视频, 使用 AnnotationsRestored.
- 如果您需要对视频进行二次编辑, 使用 Annotations2Sub.
- 不同的注释在两个软件上可能会有不同的表现, 根据情况使用最佳的软件.

### 衍生项目

[youtube_annotations_hack](https://github.com/USED255/youtube_annotations_hack)

从 archive.org 拿到了旧版 Youtube 网页经过修改后可以在本地运行, 之后用 LLM 反混淆. 可以正确的重现 Youtube Annotations, 同时进行调试.

[Youtube Annotations Text](https://huggingface.co/datasets/used255/youtube_annotations_text)

从13亿条注释存档中提取出了文本.

[Youtube Annotations video metadata](https://archive.org/details/youtube_annotations_video_metadata)

带有注释的视频的元数据数据库.
